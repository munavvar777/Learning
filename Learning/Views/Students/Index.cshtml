@model IEnumerable<Learning.Core.Entities.Student>

@{
    ViewData["Title"] = "Students List";
}

<button class="btn btn-primary mb-3" id="btnAddStudent">
    <i class="bi bi-plus-circle"></i> Add New Student
</button>

<table class="table table-striped table-bordered shadow-sm">
    <thead class="table-dark">
        <tr >
            <th>Roll Number</th>
            <th>Full Name</th>
            <th>Date of Birth</th>
            <th>Email</th>
            <th>Phone</th>
            <th>Department</th>
            <th style="width:150px;">Actions</th>
        </tr>
    </thead>
    <tbody>
        @if (Model != null)
        {
            foreach (var student in Model)
            {
                <tr id="studentRow_@student.Id">
                    <td>@student.RollNumber</td>
                    <td>@student.FullName</td>
                    <td>@student.DateOfBirth.ToString("dd-MMM-yyyy")</td>
                    <td>@student.Email</td>
                    <td>@student.Phone</td>
                    <td>@student.Department.DepartmentName</td>
                    <td>
                        <button class="btn btn-sm btn-warning btn-edit" data-id="@student.Id">
                            <i class="bi bi-pencil-square"></i> Edit
                        </button>
                        <button class="btn btn-sm btn-danger btn-delete" data-id="@student.Id">
                            <i class="bi bi-trash"></i> Delete
                        </button>
                      @*   <a asp-action="Delete" asp-route-id="@student.Id" class="btn btn-sm btn-danger">
                            <i class="bi bi-trash"></i> Delete
                        </a> *@
                    </td>
                </tr>
            }
        }
        else
        {
            <tr id="noStudentsRow">
                <td colspan="7" class="text-center text-muted">No students found.</td>
            </tr>
        }
    </tbody>
</table>

<div class="modal fade" id="studentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content shadow-lg border-0 rounded-3">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="bi bi-person-lines-fill"></i> Student</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" id="studentForm">
                <div class="modal-body" id="modalContent">
                    <!-- Partial will load here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-save"></i> Save
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {

            // Add new student
            $("#btnAddStudent").click(function () {
                $.get("/Admin/Students/CreateStudent", function (data) {
                    $("#modalContent").html(data);
                    $("#studentForm").attr("action", "/Admin/Students/CreateStudent");
                    $("#studentModal").modal("show");
                });
            });

            // Edit student
            $(document).on("click", ".btn-edit", function () {
                var id = $(this).data("id");
                $.get("/Admin/Students/EditStudent/" + id, function (data) {
                    $("#modalContent").html(data);
                    $("#studentForm").attr("action", "/Admin/Students/EditStudent");
                    $("#studentModal").modal("show");
                });
            });

        $(document).on("click", ".btn-delete", function () {
            var id = $(this).data("id");

            if (confirm("Are you sure you want to delete this student?")) {
                $.ajax({
                    type: "POST",
                    url: "/Admin/Students/DeleteStudent",
                    data: { id: id },
                    success: function (res) {
                        if (res.success) {
                            $("#studentRow_" + id).remove();

                            if ($("table tbody tr").length === 0) {
                                $("table tbody").append(`<tr id="noStudentsRow">
                                    <td colspan="7" class="text-center text-muted">No students found.</td>
                                </tr>`);
                            }
                        } else {
                            alert(res.message || "Error deleting student.");
                        }
                    }
                });
            }
        });


            // Handle form submit inside modal
            $(document).on("submit", "#studentForm", function (e) {
                e.preventDefault();
                var form = $(this);
                $.ajax({
                    type: form.attr("method"),
                    url: form.attr("action"),
                    data: form.serialize(),
                    success: function (res) {
                        if (res.success) {
                            $("#studentModal").modal("hide");

                            $("#noStudentsRow").remove();

                            var student = res.student;
                            var rowHtml = `<tr id="studentRow_${student.id}">
                                <td>${student.rollNumber}</td>
                                <td>${student.fullName}</td>
                                <td>${student.dateOfBirth}</td>
                                <td>${student.email}</td>
                                <td>${student.phone}</td>
                                <td>
                                    <button class="btn btn-sm btn-warning btn-edit" data-id="${student.id}">
                                        <i class="bi bi-pencil-square"></i> Edit
                                    </button>
                                    <a href="/Admin/Students/Delete/${student.id}" class="btn btn-sm btn-danger">
                                        <i class="bi bi-trash"></i> Delete
                                    </a>
                                </td>
                            </tr>`;

                            if (res.isNew) {
                                $("table tbody").append(rowHtml);
                            } else {
                                $("#studentRow_" + student.id).replaceWith(rowHtml);
                            }
                        } else {
                            $("#modalContent").html(res);
                        }
                    }
                });
            });

        });
    </script>
}
